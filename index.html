<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Advanced Face Recognition</title>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <style>
        :root {
            --primary-color-start: #667eea;
            --primary-color-end: #764ba2;
            --danger-color-start: #f093fb;
            --danger-color-end: #f5576c;
            --text-color: white;
            --bg-blur: rgba(255, 255, 255, 0.1);
            --bg-blur-darker: rgba(255, 255, 255, 0.15);
            --known-color: #2ecc71;
            --unknown-color: #e74c3c;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary-color-start) 0%, var(--primary-color-end) 100%);
            min-height: 100vh; display: flex; flex-direction: column; align-items: center;
            padding: 15px; color: var(--text-color);
        }
        .container {
            width: 100%; max-width: 600px;
            background: var(--bg-blur); backdrop-filter: blur(10px);
            border-radius: 20px; padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 { text-align: center; margin-bottom: 10px; font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .subtitle { text-align: center; opacity: 0.9; margin-bottom: 20px; font-size: 14px; }
        .video-container {
            position: relative; width: 100%; border-radius: 15px;
            overflow: hidden; background: #000; margin-bottom: 20px; aspect-ratio: 4 / 3;
        }
        #videoElement, #canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: scaleX(-1);
        }
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-blur-darker); padding: 15px; border-radius: 12px; text-align: center; }
        .stat-label { font-size: 12px; opacity: 0.8; margin-bottom: 5px; }
        .stat-value { font-size: 24px; font-weight: bold; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; }
        button {
            flex: 1; min-width: 120px; padding: 15px; border: none; border-radius: 12px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); color: var(--text-color);
        }
        .btn-primary { background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end)); }
        .btn-secondary { background: var(--bg-blur-darker); }
        .btn-danger { background: linear-gradient(135deg, var(--danger-color-start), var(--danger-color-end)); }
        button:active { transform: scale(0.95); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .status { 
            margin-top: 15px; padding: 15px; border-radius: 12px; 
            background: var(--bg-blur-darker); text-align: center; 
            font-size: 14px; transition: background-color 0.3s; 
        }
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.active { display: block; }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid var(--text-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .person-list { margin-top: 15px; max-height: 200px; overflow-y: auto; }
        .person-item {
            background: var(--bg-blur); padding: 10px; margin-bottom: 8px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .person-item button { 
            padding: 5px 10px; background: var(--unknown-color); 
            border-radius: 5px; min-width: auto; flex: 0; 
        }
        .alert-info { background-color: rgba(52, 152, 219, 0.3); }
        .alert-warning { background-color: rgba(241, 196, 15, 0.3); }
        .alert-success { background-color: rgba(46, 204, 113, 0.3); }
    </style>
</head>
<body>
    <div class="container">
        <h1>Advanced Face Recognition</h1>
        <div class="subtitle">Multi-Sample Registration & Unknown Detection</div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div id="loading-text">Loading AI models...</div>
        </div>
        
        <div class="video-container">
            <video id="videoElement" autoplay muted playsinline></video>
            <canvas id="canvas"></canvas>
        </div>
        
        <div class="stats">
            <div class="stat-card"><div class="stat-label">Faces Detected</div><div class="stat-value" id="faceCount">0</div></div>
            <div class="stat-card"><div class="stat-label">Registered</div><div class="stat-value" id="registeredCount">0</div></div>
        </div>
        
        <div class="controls">
            <button class="btn-primary" id="startBtn">Start Camera</button>
            <button class="btn-secondary" id="registerBtn" disabled>Register New Face</button>
            <button class="btn-danger" id="stopBtn" disabled>Stop</button>
        </div>
        
        <div class="status" id="status">Ready to start.</div>
        <div class="person-list" id="personList"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elemen DOM ---
            const videoElement = document.getElementById('videoElement');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const loadingDiv = document.getElementById('loading');
            const loadingText = document.getElementById('loading-text');
            const startBtn = document.getElementById('startBtn');
            const registerBtn = document.getElementById('registerBtn');
            const stopBtn = document.getElementById('stopBtn');

            // --- Variabel State ---
            let stream = null;
            let detectionInterval = null;
            let faceDatabase = [];
            let faceMatcher = null;
            let modelsLoaded = false;

            // --- Konfigurasi ---
            const MODELS_URL = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights';
            const DETECTION_INTERVAL_MS = 300;
            const SAMPLES_FOR_REGISTRATION = 5;
            const DISTANCE_THRESHOLD = 0.6;

            // =================================================================
            // === FUNGSI UTAMA (Inisialisasi, Kamera, Deteksi)
            // =================================================================

            async function initialize() {
                await loadModels();
                loadFromMemory();
            }

            async function loadModels() {
                loadingDiv.classList.add('active');
                try {
                    loadingText.textContent = 'Loading face detection models...';
                    
                    await faceapi.nets.tinyFaceDetector.loadFromUri(MODELS_URL);
                    loadingText.textContent = 'Loading facial landmarks...';
                    
                    await faceapi.nets.faceLandmark68Net.loadFromUri(MODELS_URL);
                    loadingText.textContent = 'Loading face recognition...';
                    
                    await faceapi.nets.faceRecognitionNet.loadFromUri(MODELS_URL);
                    
                    modelsLoaded = true;
                    loadingDiv.classList.remove('active');
                    updateStatus('✓ Models loaded! Click "Start Camera" to begin.', 'success');
                    startBtn.disabled = false;
                } catch (error) {
                    loadingDiv.classList.remove('active');
                    console.error("Error loading models: ", error);
                    updateStatus('❌ Error loading models. Please refresh the page.', 'warning');
                }
            }

            async function startCamera() {
                if (!modelsLoaded) {
                    updateStatus('Models are still loading. Please wait...', 'warning');
                    return;
                }
                
                try {
                    const constraints = { 
                        video: { 
                            facingMode: 'user', 
                            width: { ideal: 1280 }, 
                            height: { ideal: 720 } 
                        } 
                    };
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    videoElement.srcObject = stream;
                    
                    videoElement.onloadedmetadata = () => {
                        canvas.width = videoElement.videoWidth;
                        canvas.height = videoElement.videoHeight;
                        setButtonsState(true);
                        updateStatus('✓ Camera started. Detecting faces...', 'success');
                        startDetection();
                    };
                } catch (error) {
                    console.error('Camera error:', error);
                    updateStatus('❌ Camera access denied: ' + error.message, 'warning');
                }
            }
            
            function stopCamera() {
                stopDetection();
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                videoElement.srcObject = null;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                setButtonsState(false);
                updateStatus('Camera stopped.', 'info');
                document.getElementById('faceCount').textContent = 0;
            }

            async function detectFaces() {
                if (!videoElement || videoElement.readyState !== 4) return;

                try {
                    const detections = await faceapi.detectAllFaces(
                        videoElement, 
                        new faceapi.TinyFaceDetectorOptions({ 
                            inputSize: 416,
                            scoreThreshold: 0.5 
                        })
                    )
                    .withFaceLandmarks()
                    .withFaceDescriptors();

                    document.getElementById('faceCount').textContent = detections.length;
                    
                    const displaySize = { width: canvas.width, height: canvas.height };
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    if (detections.length > 0 && faceMatcher) {
                        resizedDetections.forEach(detection => {
                            const result = faceMatcher.findBestMatch(detection.descriptor);
                            drawDetectionResult(detection, result);
                        });
                    } else if (detections.length > 0) {
                        resizedDetections.forEach(detection => {
                            drawDetectionResult(detection, null);
                        });
                    }
                } catch (error) {
                    console.error('Detection error:', error);
                }
            }

            // =================================================================
            // === FUNGSI REGISTRASI (Multi-Sampel)
            // =================================================================
            
            async function registerFace() {
                const name = prompt('Enter name for face registration:');
                if (!name || name.trim() === '') return;
                
                const trimmedName = name.trim();
                
                if (faceDatabase.some(p => p.name.toLowerCase() === trimmedName.toLowerCase())) {
                    updateStatus('⚠ Name already exists. Please use a different name.', 'warning');
                    return;
                }
                
                stopDetection();
                updateStatus('Preparing registration...', 'info');
                
                let descriptors = [];
                
                for (let i = 1; i <= SAMPLES_FOR_REGISTRATION; i++) {
                    updateStatus(`📸 Capturing sample ${i}/${SAMPLES_FOR_REGISTRATION}... Hold still!`, 'info');
                    
                    await new Promise(resolve => setTimeout(resolve, 800));
                    
                    const detection = await faceapi.detectSingleFace(
                        videoElement, 
                        new faceapi.TinyFaceDetectorOptions({ inputSize: 416 })
                    )
                    .withFaceLandmarks()
                    .withFaceDescriptor();
                    
                    if (detection) {
                        descriptors.push(Array.from(detection.descriptor));
                        
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        const box = detection.detection.box;
                        ctx.strokeStyle = '#2ecc71';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(box.x, box.y, box.width, box.height);
                        ctx.fillStyle = '#2ecc71';
                        ctx.font = '16px sans-serif';
                        ctx.fillText(`Sample ${i}/${SAMPLES_FOR_REGISTRATION}`, box.x, box.y - 10);
                    } else {
                        i--;
                        updateStatus(`⚠ Sample failed. Adjust position and lighting.`, 'warning');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }

                if (descriptors.length === SAMPLES_FOR_REGISTRATION) {
                    const avgDescriptor = averageDescriptors(descriptors);
                    faceDatabase.push({ name: trimmedName, descriptor: avgDescriptor });
                    saveToMemory();
                    updateUIAfterDBChange();
                    updateStatus(`✓ ${trimmedName} registered successfully with ${SAMPLES_FOR_REGISTRATION} samples!`, 'success');
                } else {
                    updateStatus('❌ Registration failed. Not enough samples captured.', 'warning');
                }
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                startDetection();
            }
            
            function averageDescriptors(descriptors) {
                const numDescriptors = descriptors.length;
                const descriptorSize = descriptors[0].length;
                const avgDescriptor = new Array(descriptorSize).fill(0);

                for (let i = 0; i < descriptorSize; i++) {
                    for (let j = 0; j < numDescriptors; j++) {
                        avgDescriptor[i] += descriptors[j][i];
                    }
                    avgDescriptor[i] /= numDescriptors;
                }
                return avgDescriptor;
            }

            // =================================================================
            // === FUNGSI PEMBANTU (UI, Penyimpanan, Logika Tambahan)
            // =================================================================
            
            function drawDetectionResult(detection, result) {
                const box = detection.detection.box;
                let label = "Detecting...";
                let boxColor = '#ffd700';

                if (result) {
                    const confidence = Math.round((1 - result.distance) * 100);
                    
                    if (result.distance < DISTANCE_THRESHOLD) {
                        label = `${result.label} (${confidence}%)`;
                        boxColor = '#2ecc71';
                    } else {
                        label = `Unknown (${confidence}%)`;
                        boxColor = '#e74c3c';
                    }
                } else {
                    label = faceDatabase.length > 0 ? "Unknown" : "No database";
                    boxColor = faceDatabase.length > 0 ? '#e74c3c' : '#ff9800';
                }
                
                ctx.strokeStyle = boxColor;
                ctx.lineWidth = 3;
                ctx.strokeRect(box.x, box.y, box.width, box.height);
                
                ctx.fillStyle = boxColor;
                ctx.font = 'bold 16px sans-serif';
                const textWidth = ctx.measureText(label).width;
                ctx.fillRect(box.x, box.y - 25, textWidth + 10, 25);
                
                ctx.fillStyle = '#000';
                ctx.fillText(label, box.x + 5, box.y - 7);
            }

            function loadFromMemory() {
                const stored = localStorage.getItem('faceDatabase');
                if (stored) {
                    try {
                        faceDatabase = JSON.parse(stored);
                        updateUIAfterDBChange();
                        updateStatus(`Loaded ${faceDatabase.length} registered face(s).`, 'info');
                    } catch (e) {
                        console.error('Error loading from storage:', e);
                        faceDatabase = [];
                    }
                }
            }
            
            function saveToMemory() { 
                localStorage.setItem('faceDatabase', JSON.stringify(faceDatabase)); 
            }
            
            window.removePerson = function(index) {
                const person = faceDatabase[index];
                if (confirm(`Remove ${person.name} from database?`)) {
                    faceDatabase.splice(index, 1);
                    saveToMemory();
                    updateUIAfterDBChange();
                    updateStatus(`✓ ${person.name} removed from database.`, 'info');
                }
            };

            function updateUIAfterDBChange() {
                document.getElementById('registeredCount').textContent = faceDatabase.length;
                updatePersonList();
                
                if (faceDatabase.length > 0) {
                    const labeledDescriptors = faceDatabase.map(p => 
                        new faceapi.LabeledFaceDescriptors(
                            p.name, 
                            [new Float32Array(p.descriptor)]
                        )
                    );
                    faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, DISTANCE_THRESHOLD);
                } else {
                    faceMatcher = null;
                }
            }
            
            function updatePersonList() {
                const listDiv = document.getElementById('personList');
                if (faceDatabase.length === 0) {
                    listDiv.innerHTML = '';
                    return;
                }
                
                listDiv.innerHTML = '<div style="padding: 10px; opacity: 0.8; font-weight: bold;">📋 Registered People:</div>';
                
                faceDatabase.forEach((p, i) => {
                    const item = document.createElement('div');
                    item.className = 'person-item';
                    item.innerHTML = `
                        <span>👤 ${p.name}</span>
                        <button onclick="removePerson(${i})">✕</button>
                    `;
                    listDiv.appendChild(item);
                });
            }
            
            function updateStatus(message, type = 'info') {
                const statusDiv = document.getElementById('status');
                statusDiv.textContent = message;
                statusDiv.className = `status alert-${type}`;
            }

            function setButtonsState(isCameraOn) {
                startBtn.disabled = isCameraOn;
                registerBtn.disabled = !isCameraOn;
                stopBtn.disabled = !isCameraOn;
            }

            function startDetection() { 
                if (!detectionInterval) {
                    detectionInterval = setInterval(detectFaces, DETECTION_INTERVAL_MS); 
                }
            }
            
            function stopDetection() { 
                if (detectionInterval) {
                    clearInterval(detectionInterval); 
                    detectionInterval = null; 
                }
            }

            // --- EVENT LISTENERS ---
            startBtn.addEventListener('click', startCamera);
            stopBtn.addEventListener('click', stopCamera);
            registerBtn.addEventListener('click', registerFace);
            
            // --- MULAI APLIKASI ---
            initialize();
        });
    </script>
</body>
</html>
